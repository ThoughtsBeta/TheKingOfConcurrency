æ¬¢è¿Žæ¥åˆ°ã€Š[çŽ‹è€…å¹¶å‘è¯¾](https://github.com/ThoughtsBeta/TheKingOfConcurrency)ã€‹ï¼Œæœ¬æ–‡æ˜¯è¯¥ç³»åˆ—æ–‡ç« ä¸­çš„**ç¬¬21ç¯‡**ï¼Œé“‚é‡‘ä¸­çš„**ç¬¬8ç¯‡**ã€‚

åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†CountDownLatchçš„ç”¨æ³•ã€‚åœ¨åè°ƒå¤šçº¿ç¨‹çš„å¼€å§‹å’Œç»“æŸæ—¶ï¼ŒCountDownLatchæ˜¯ä¸ªéžå¸¸ä¸é”™çš„é€‰æ‹©ã€‚è€Œæœ¬æ–‡å³å°†ç»™ä½ ä»‹ç»çš„CyclicBarrieråˆ™æ›´åŠ æœ‰è¶£ï¼Œå®ƒåœ¨èƒ½åŠ›ä¸Šå’ŒCountDownLatchæ—¢æœ‰ç›¸ä¼¼ä¹‹å¤„ï¼Œåˆæœ‰ç€æ˜Žæ˜¾çš„ä¸åŒï¼Œå€¼å¾—ä½ ä¸€è§ˆç©¶ç«Ÿã€‚æœ¬æ–‡ä¼šå…ˆä»Žåœºæ™¯ä¸Šå¸¦ä½ ç†è§£é—®é¢˜ï¼Œå†åŽ»ç†è§£CyclicBarrieræä¾›çš„æ–¹æ¡ˆã€‚

## ä¸€ã€CyclicBarrieråˆä½“éªŒ

**1. å³¡è°·æ£®æž—é‡Œçš„çˆ±æƒ…**

åœ¨å³¡è°·çš„æ±Ÿæ¹–ä¸­ï¼Œä¸ä»…æœ‰ç”Ÿæ€äºˆå¤ºå’Œåˆ€å…‰å‰‘å½±ï¼Œè¿˜æœ‰ç€ç¾Žå¦™çš„çˆ±æƒ…æ•…äº‹ã€‚

å³¡è°·æˆ˜ç¥žé“ æ›¾ç»åœ¨å±æ€¥å…³å¤´æ•‘äº†å¤§ä¹”ï¼Œè¿™ä¸€å‡ºè‹±é›„æ•‘ç¾Žè®©ä»–ä»¬æ“¦é™¤äº†çˆ±æƒ…çš„ç«èŠ±ï¼Œæœ‰äº‹æ²¡äº‹ä¸¤äººå°±åœ¨å³¡è°·ä¸­çš„å„ä¸ªè§’è½å¹½ä¼šã€‚å…¶ä¸­ï¼Œ**å³¡è°·æ£®æž—**å°±æ˜¯ä»–ä»¬å¸¸åŽ»çš„åœ°æ–¹ï¼Œ**è°å…ˆåˆ°å°±ç­‰å¦ä¸€ä¸ªï¼Œä¸¤äººéƒ½åˆ°é½åŽï¼Œå†ä¸€èµ·çŽ©è€ã€åˆ‡ç£‹æ­¦è‰º**ã€‚

![](https://writting.oss-cn-beijing.aliyuncs.com/2021/07/04/16253940624021.jpg)

è¿™é‡Œå¤´ï¼Œæœ‰ä¸¤ä¸ªé‡ç‚¹ã€‚ä¸€æ˜¯ä»–ä»¬è¦**ç›¸äº’ç­‰å¾…**ï¼ŒäºŒæ˜¯éƒ½åˆ°é½åŽå†**çŽ©è€**ã€‚çŽ°åœ¨ï¼Œæˆ‘ä»¬è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æžœç”¨ä»£ç æ¥æ¨¡æ‹Ÿè¿™ä¸ªåœºæ™¯çš„è¯ï¼Œä½ æ‰“ç®—æ€Žä¹ˆåšã€‚æœ‰çš„åŒå­¦å¯èƒ½ä¼šè¯´ï¼Œä¸¤ä¸ªäººï¼ˆçº¿ç¨‹ï¼‰çš„ç­‰å¾…å¾ˆå¥½å¤„ç†ã€‚**å¯æ˜¯ï¼Œå¦‚æžœæ˜¯ä¸‰äººå‘¢**ï¼Ÿ

æ‰€ä»¥ï¼Œè¿™ä¸ªåœºæ™¯é—®é¢˜å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š**å¤šä¸ªçº¿ç¨‹ç›¸äº’ç­‰å¾…ï¼Œåˆ°é½åŽå†æ‰§è¡Œç‰¹å®šåŠ¨ä½œ**ã€‚

æŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±é€šè¿‡CyclicBarrieræ¥æ¨¡æ‹Ÿè§£å†³è¿™ä¸ªåœºæ™¯çš„é—®é¢˜ï¼Œç›´è§‚æ„Ÿå—CyclicBarrierçš„ç”¨æ³•ã€‚

åœ¨ä¸‹é¢è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª**å¹½ä¼šåœ°ç‚¹ï¼ˆappointmentPlaceï¼‰**ï¼Œä»¥åŠ**å¤§ä¹”**å’Œ**é“ **è¿™ä¸¤ä¸ªä¸»äººå…¬ã€‚åœ¨ä»–ä»¬éƒ½è¾¾åˆ°å¹½ä¼šåœ°ç‚¹åŽï¼Œæˆ‘ä»¬è¾“å‡ºä¸€å¥åŒ…å«ä¸‰æœµçŽ«ç‘°ðŸŒ¹ðŸŒ¹ðŸŒ¹çš„è¯æ¥äºˆä»¥ç¡®è®¤ï¼Œç»™ä»–ä»¬é€ä¸Šç¥ç¦ã€‚

```java
 private static String appointmentPlace = "å³¡è°·æ£®æž—";

 public static void main(String[] args) {
   CyclicBarrier cyclicBarrier = new CyclicBarrier(2, () -> print("ðŸŒ¹ðŸŒ¹ðŸŒ¹åˆ°è¾¾çº¦ä¼šåœ°ç‚¹ï¼šå¤§ä¹”å’Œé“ éƒ½æ¥åˆ°äº†ðŸ‘‰" + appointmentPlace));
   Thread å¤§ä¹” = newThread("å¤§ä¹”", () -> {
     say("é“ ï¼Œä½ åœ¨å“ªé‡Œ...");
     try {
       cyclicBarrier.await(); //åˆ°è¾¾å¹½ä¼šåœ°ç‚¹
       say("é“ ï¼Œä½ ç»ˆäºŽæ¥äº†...");
     } catch (Exception e) {
       e.printStackTrace();
     }
   });

   Thread é“  = newThread("é“ ", () -> {
     try {
       Thread.sleep(500); //é“ æ‰“é‡Žä¸­
       say("æˆ‘æ‰“ä¸ªé‡Žï¼Œé©¬ä¸Šå°±åˆ°!");
       cyclicBarrier.await(); //åˆ°è¾¾å¹½ä¼šåœ°ç‚¹
       say("ä¹”ï¼Œä¸å¥½æ„æ€ï¼Œåˆšæ‰“é‡Žé‡ä¸Šå…°é™µçŽ‹äº†ï¼Œä½ è¿˜å¥½å—ï¼Ÿï¼");
     } catch (Exception e) {
       e.printStackTrace();
     }
   });

   å¤§ä¹”.start();
   é“ .start();
 }

```
è¾“å‡ºç»“æžœå¦‚ä¸‹ï¼š

```shell
å¤§ä¹”:é“ ï¼Œä½ åœ¨å“ªé‡Œ...
é“ :æˆ‘æ‰“ä¸ªé‡Žï¼Œé©¬ä¸Šå°±åˆ°!
ðŸŒ¹ðŸŒ¹ðŸŒ¹åˆ°è¾¾çº¦ä¼šåœ°ç‚¹ï¼šå¤§ä¹”å’Œé“ éƒ½æ¥åˆ°äº†ðŸ‘‰å³¡è°·æ£®æž—
é“ :ä¹”ï¼Œä¸å¥½æ„æ€ï¼Œåˆšæ‰“é‡Žé‡ä¸Šå…°é™µçŽ‹äº†ï¼Œä½ è¿˜å¥½å—ï¼Ÿï¼
å¤§ä¹”:é“ ï¼Œä½ ç»ˆäºŽæ¥äº†...

Process finished with exit code 0
```
å¯¹äºŽä»£ç çš„ç»†èŠ‚æš‚ä¸”ä¸å¿…æ·±ç©¶ï¼Œæœ¬æ–‡åŽé¢å¯¹CyclicBarrierçš„å†…éƒ¨ç»†èŠ‚ä¼šæœ‰è¯¦è§£ï¼Œå…ˆæ„Ÿå—å®ƒçš„åŸºæœ¬ç”¨æ³•ã€‚

ä»Žç»“æžœä¸­å¯ä»¥çœ‹åˆ°ï¼Œ**CyclicBarrierå¯ä»¥åƒCountDownLatchä¸€æ ·ï¼Œåè°ƒå¤šçº¿ç¨‹çš„æ‰§è¡Œç»“æŸåŠ¨ä½œï¼Œåœ¨å®ƒä»¬éƒ½ç»“æŸåŽæ‰§è¡Œç‰¹å®šåŠ¨ä½œ**ã€‚ä»Žè¿™ç‚¹ä¸Šæ¥è¯´ï¼Œè¿™æ˜¯CyclicBarrierä¸ŽCountDownLatchç›¸ä¼¼ä¹‹å¤„ã€‚ç„¶è€Œï¼ŒæŽ¥ä¸‹æ¥çš„è¿™ä¸ªåœºæ™¯ï¼Œæ‰€ä½“çŽ°çš„åˆ™æ˜¯å®ƒä»¬ä¸€ä¸ªæ˜Žæ˜¾çš„ä¸åŒä¹‹å¤„ã€‚


**2. å°æ²³è¾¹çš„å¹½ä¼š**

åœ¨ä¸Šé¢çš„åœºæ™¯ä¸­ï¼Œé“ å·²ç»æåˆ°ä»–åœ¨æ‰“é‡Žæ—¶é‡åˆ°äº†å…°é™µçŽ‹ã€‚è€Œåœ¨é“ ä¸Žå¤§ä¹”çš„çº¦ä¼šä¸­ï¼Œå…°é™µçŽ‹ç«Ÿç„¶åˆæ’žè§äº†ä»–ä»¬ï¼ŒçœŸæ˜¯å†¤å®¶è·¯çª„ã€‚äºŽæ˜¯ï¼Œåœ¨å…°é™µçŽ‹çš„æ…å±€ä¸‹ï¼Œé“ å’Œå¤§ä¹”ä¸å¾—ä¸è½¬ç§»é˜µåœ°ï¼Œ**ä»–ä»¬åŒæ ·çº¦å®šåˆ°æ–°çš„çº¦å®šåœ°ç‚¹åŽç­‰å¾…å¯¹æ–¹**ã€‚ï¼ˆ**é“ ä¸€ç›´ä»¥ä¸ºå…°é™µçŽ‹ä¹Ÿå–œæ¬¢å¤§ä¹”ï¼Œè¦å’Œä»–æ¨ªåˆ€å¤ºçˆ±ï¼Œå…¶å®žå…°é™µçŽ‹åœ¨ä¹Žçš„åªæ˜¯é“ æ‰“äº†å®ƒçš„é‡Žï¼Œä»–çš„å¿ƒé‡Œåªæœ‰é‡Žæ€ªï¼Œå¯¹ä»»ä½•å¥³äººæ¯«æ— å…´è¶£**ï¼‰ã€‚

![](https://writting.oss-cn-beijing.aliyuncs.com/2021/07/04/16253951409684.jpg)

æ­¤æ—¶ï¼Œå¦‚æžœç»§ç»­ç”¨ä»£ç æ¨¡æ‹Ÿè¿™ä¸€åœºæ™¯çš„è¯ï¼Œé‚£ä¹ˆCountDownLatchå°±æ— èƒ½ä¸ºåŠ›äº†ï¼Œ**å› ä¸ºCountDownLatchçš„ä½¿ç”¨æ˜¯ä¸€æ¬¡æ€§çš„**ï¼Œæ— æ³•é‡å¤åˆ©ç”¨ã€‚è€Œæ­¤æ—¶ï¼Œ**ä½ å°±ä¼šå‘çŽ°CyclicBarrierçš„ç¥žå¥‡ä¹‹å¤„ï¼Œå®ƒç«Ÿç„¶å¯ä»¥é‡å¤åˆ©ç”¨**ã€‚ä¼¼ä¹Žï¼Œä½ å¯èƒ½å·²ç»å¤§æ¦‚æ˜Žç™½å®ƒä¸ºä»€ä¹ˆå«**Cyclic**çš„åŽŸå› äº†ã€‚

æŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†èµ°ä¸€æ®µä»£ç ï¼Œæ¨¡æ‹Ÿå¤§ä¹”å’Œé“ çš„ç¬¬äºŒæ¬¡å¹½ä¼šã€‚åœ¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä»ç„¶å®šä¹‰å¹½ä¼šåœ°ç‚¹ã€å¤§ä¹”å’Œé“ ä¸¤ä¸ªä¸»äººå…¬ã€‚**ä½†æ˜¯ä¸Žæ­¤å‰ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬è¿˜å¢žåŠ äº†å…°é™µçŽ‹è¿™ä¸ªæ…å±€è€…ï¼Œä»¥åŠä¸­é€”å˜æ›´äº†å¹½ä¼šåœ°ç‚¹**ã€‚

```java
private static String appointmentPlace = "å³¡è°·æ£®æž—";

public static void main(String[] args) {
  CyclicBarrier cyclicBarrier = new CyclicBarrier(2, () -> System.out.println("ðŸŒ¹ðŸŒ¹ðŸŒ¹åˆ°è¾¾çº¦ä¼šåœ°ç‚¹ï¼šå¤§ä¹”å’Œé“ éƒ½æ¥åˆ°äº†ðŸ‘‰" + appointmentPlace));
  Thread å¤§ä¹” = newThread("å¤§ä¹”", () -> {
    say("é“ ï¼Œä½ åœ¨å“ªé‡Œ...");
    try {
      cyclicBarrier.await();
      say("é“ ï¼Œä½ ç»ˆäºŽæ¥äº†...");
      Thread.sleep(2600); //çº¦ä¼šä¸­...
      say("å¥½çš„ï¼Œä½ è¦å°å¿ƒï¼");
      cyclicBarrier.await(); // æ³¨æ„è¿™é‡Œæ˜¯ç¬¬äºŒæ¬¡è°ƒç”¨await
      Thread.sleep(100);
      say("çœŸå¥½ï¼");
    } catch (Exception e) {
      e.printStackTrace();
    }
  });

  Thread é“  = newThread("é“ ", () -> {
    try {
      Thread.sleep(500); //é“ æ‰“é‡Žä¸­
      say("æˆ‘æ‰“ä¸ªé‡Žï¼Œé©¬ä¸Šå°±åˆ°!");
      cyclicBarrier.await(); //åˆ°è¾¾å¹½ä¼šåœ°ç‚¹
      say("ä¹”ï¼Œä¸å¥½æ„æ€ï¼Œåˆšæ‰“é‡Žé‡ä¸Šå…°é™µçŽ‹äº†ï¼Œä½ è¿˜å¥½å—ï¼Ÿï¼");
      Thread.sleep(1500); //å¹½ä¼šä¸­...

      note("å¹½ä¼šä¸­...\n");

      Thread.sleep(1000); //å¹½ä¼šä¸­...
      say("è¿™ä¸ªè¯¥æ­»çš„å…°é™µçŽ‹ï¼ä¹”ï¼Œä½ å…ˆèµ°ï¼Œå°æ²³è¾¹è§ï¼"); //é“ çªç„¶çœ‹åˆ°äº†å…°é™µçŽ‹
      appointmentPlace = "å°æ²³è¾¹"; // é“ æŠŠåœ°ç‚¹æ”¹æˆäº†å°æ²³è¾¹

      Thread.sleep(1500); //å’Œå…°é™µçŽ‹å¯¹å†³ä¸­...
      note("ï¸Ž\uD83D\uDDE1\uD83D\uDD2Aé“ å’Œå…°é™µçŽ‹å†³æˆ˜å¼€å§‹ï¼Œæœ€ç»ˆé“ æ€æ­»äº†å…°é™µçŽ‹ï¼Œå¹¶å‰å¾€å°æ²³è¾¹...\n");
      cyclicBarrier.await(); // æ€äº†å…°é™µçŽ‹åŽï¼Œé“ åˆ°äº†å°æ²³è¾¹ ï¼ï¼ï¼æ³¨æ„è¿™é‡Œæ˜¯ç¬¬äºŒæ¬¡è°ƒç”¨await

      say("ä¹”ï¼Œæˆ‘å·²ç»è§£å†³äº†å…°é™µçŽ‹ï¼Œä½ çœ‹ä»Šæ™šå¤œè‰²å¤šç¾Žï¼Œæˆ‘é™ªä½ çœ‹æ˜Ÿæ˜Ÿåˆ°å¤©æ˜Ž...");
    } catch (Exception ignored) {}
  });

  Thread å…°é™µçŽ‹ = newThread("å…°é™µçŽ‹", () -> {
    try {
      Thread.sleep(2500);
      note("å…°é™µçŽ‹å‡ºåœº...");
      say("é“ æ‰“äº†æˆ‘çš„é‡Žï¼Œä¸æ€ä»–èª“ä¸ç½¢ä¼‘ï¼");

      say("é“ ï¼ŒåŽŸæ¥ä½ å’Œå¤§ä¹”åœ¨è¿™é‡Œï¼\uD83D\uDDE1ï¸\uD83D\uDDE1ï¸");
    } catch (Exception ignored) {}
  });

  å…°é™µçŽ‹.start();
  å¤§ä¹”.start();
  é“ .start();
}

```

è¾“å‡ºç»“æžœå¦‚ä¸‹æ‰€ç¤ºã€‚**é“ å³¡è°·æ£®æž—çš„å¥½äº‹è¢«å…°é™µçŽ‹æ…å±€åŽï¼Œé“ æ€’ç«ä¸­çƒ§ï¼Œè®©å¤§ä¹”å…ˆèµ°ï¼Œå¹¶çº¦å®šåœ¨å°æ²³è¾¹ç¢°é¢ã€‚éšåŽï¼Œé“ æ–©æ€äº†å…°é™µçŽ‹ï¼ˆå¯æ€œçš„é’¢é“ç›´ç”·ï¼‰ï¼Œå¹¶å‰å¾€å°æ²³è¾¹ï¼Œå®Œæˆä»–å’Œå¤§ä¹”çš„ç¬¬äºŒæ¬¡å¹½ä¼š**ã€‚

```java
å¤§ä¹”:é“ ï¼Œä½ åœ¨å“ªé‡Œ...
é“ :æˆ‘æ‰“ä¸ªé‡Žï¼Œé©¬ä¸Šå°±åˆ°!
ðŸŒ¹ðŸŒ¹ðŸŒ¹åˆ°è¾¾çº¦ä¼šåœ°ç‚¹ï¼šå¤§ä¹”å’Œé“ éƒ½æ¥åˆ°äº†ðŸ‘‰å³¡è°·æ£®æž—
é“ :ä¹”ï¼Œä¸å¥½æ„æ€ï¼Œåˆšæ‰“é‡Žé‡ä¸Šå…°é™µçŽ‹äº†ï¼Œä½ è¿˜å¥½å—ï¼Ÿï¼
å¤§ä¹”:é“ ï¼Œä½ ç»ˆäºŽæ¥äº†...
å¹½ä¼šä¸­...

å…°é™µçŽ‹å‡ºåœº...
å…°é™µçŽ‹:é“ æ‰“äº†æˆ‘çš„é‡Žï¼Œä¸æ€ä»–èª“ä¸ç½¢ä¼‘ï¼
å…°é™µçŽ‹:é“ ï¼ŒåŽŸæ¥ä½ å’Œå¤§ä¹”åœ¨è¿™é‡Œï¼ðŸ—¡ï¸ðŸ—¡ï¸
é“ :è¿™ä¸ªè¯¥æ­»çš„å…°é™µçŽ‹ï¼ä¹”ï¼Œä½ å…ˆèµ°ï¼Œå°æ²³è¾¹è§ï¼
å¤§ä¹”:å¥½çš„ï¼Œä½ è¦å°å¿ƒï¼
ï¸ŽðŸ—¡ðŸ”ªé“ å’Œå…°é™µçŽ‹å†³æˆ˜å¼€å§‹ï¼Œæœ€ç»ˆé“ æ€æ­»äº†å…°é™µçŽ‹ï¼Œå¹¶å‰å¾€å°æ²³è¾¹...

ðŸŒ¹ðŸŒ¹ðŸŒ¹åˆ°è¾¾çº¦ä¼šåœ°ç‚¹ï¼šå¤§ä¹”å’Œé“ éƒ½æ¥åˆ°äº†ðŸ‘‰å°æ²³è¾¹
é“ :ä¹”ï¼Œæˆ‘å·²ç»è§£å†³äº†å…°é™µçŽ‹ï¼Œä½ çœ‹ä»Šæ™šå¤œè‰²å¤šç¾Žï¼Œæˆ‘é™ªä½ çœ‹æ˜Ÿæ˜Ÿåˆ°å¤©æ˜Ž...
å¤§ä¹”:çœŸå¥½ï¼

Process finished with exit code 0
```

åŒæ ·çš„ï¼Œä½ æš‚æ—¶ä¸è¦ç†ä¼šä»£ç çš„ç»†èŠ‚ï¼Œ**ä½†æ˜¯ä½ è¦æ³¨æ„åˆ°å…¶ä¸­é“ å’Œå¤§ä¹”å¯¹`await()`çš„ä¸¤æ¬¡è°ƒç”¨**ã€‚åœ¨ä½ æ²¡æœ‰ç†è§£å®ƒçš„åŽŸç†ä¹‹å‰ï¼Œå¯èƒ½ä¼šæƒŠè®¶äºŽå®ƒçš„ç¥žå¥‡ï¼Œè¿™æ˜¯æ­£å¸¸çŽ°è±¡ã€‚


## äºŒã€CyclicBarrieræ˜¯å¦‚ä½•å®žçŽ°çš„


CyclicBarrieræ˜¯Javaä¸­æä¾›çš„ä¸€ä¸ªçº¿ç¨‹åŒæ­¥å·¥å…·ï¼Œä¸ŽCountDownLatchç›¸ä¼¼ï¼Œä½†åˆå¹¶ä¸å®Œå…¨ç›¸åŒï¼Œ**æœ€æ ¸å¿ƒçš„åŒºåˆ«åœ¨äºŽCyclicBarrieræ˜¯å¯ä»¥å¾ªçŽ¯ä½¿ç”¨çš„ï¼Œè¿™ä¸€ç‚¹åœ¨å®ƒçš„åå­—ä¸­ä¹Ÿå·²ç»æœ‰æ‰€ä½“çŽ°**ã€‚

æŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥åˆ†æžä¸‹å®ƒå…·ä½“çš„æºç å®žçŽ°ã€‚


**1. æ ¸å¿ƒæ•°æ®ç»“æž„**

* `private final ReentrantLock lock = new ReentrantLock()`ï¼šè¿›å…¥å±éšœçš„é”ï¼Œåªæœ‰ä¸€æŠŠï¼›
* `private final Condition trip = lock.newCondition()`ï¼šå’Œä¸Šé¢çš„locké…å¥—ä½¿ç”¨ï¼›
* `private final int parties`ï¼šå‚ä¸Žæ–¹çš„æ•°é‡ï¼Œæœ¬æ–‡ä¸Šè¿°çš„ä¾‹å­åªæœ‰é“ å’Œå¤§ä¹”ï¼Œæ‰€ä»¥æ•°é‡æ˜¯2ï¼›
* `private final Runnable barrierCommand`ï¼šåœ¨æœ¬è½®ç»“æŸæ—¶è¿è¡Œçš„ç‰¹å®šä»£ç ã€‚æœ¬æ–‡ä¸Šè¿°ä¾‹å­ç”¨åˆ°äº†å®ƒï¼Œå¯ä»¥ä¸Šç¿»æŸ¥çœ‹ï¼›
* `private Generation generation = new Generation()`ï¼šå½“å‰å±éšœçš„ä»£æ¬¡ã€‚æ¯”å¦‚æœ¬æ–‡ä¸Šè¿°çš„ä¸¤ä¸ªåœºæ™¯ä¸­ï¼Œgenerationæ˜¯ä¸åŒçš„ï¼Œåœ¨é“ å’Œå¤§ä¹”å°†å¹½ä¼šåœ°ç‚¹æ”¹æˆå°æ²³è¾¹åŽï¼Œä¼šç”Ÿæˆæ–°çš„generationï¼›
* `private int count`ï¼šæ­£åœ¨ç­‰å¾…çš„å‚ä¸Žæ–¹æ•°é‡ã€‚åœ¨æ¯ä¸ªä»£æ¬¡ä¸­ï¼Œcountä¼šä»Žæœ€åˆçš„å‚ä¸Žæ•°é‡ï¼ˆå³partiesï¼‰é™è‡³0ï¼Œåˆ°0æ—¶æœ¬ä»£æ¬¡ç»“æŸï¼Œè€Œåœ¨æ–°çš„ä»£æ¬¡æˆ–æœ¬ä»£æ¬¡è¢«æ‹†é™¤ï¼ˆbrokenï¼‰æ—¶ï¼Œcountçš„å€¼ä¼šæ¢å¤ä¸ºpartiesçš„å€¼ã€‚

**2. æ ¸å¿ƒæž„é€ **

* `public CyclicBarrier(int parties)`ï¼šæŒ‡å®šå‚ä¸Žæ–¹çš„æ•°é‡ï¼›
* `public CyclicBarrier(int parties, Runnable barrierAction)`ï¼šæŒ‡å®šå‚ä¸Žæ–¹çš„æ•°é‡ï¼Œå¹¶æŒ‡å®šåœ¨æœ¬ä»£æ¬¡ç»“æŸæ—¶è¿è¡Œçš„ä»£ç ã€‚

**3. æ ¸å¿ƒæ–¹æ³•**

* `public int await()`ï¼šå¦‚æžœå½“å‰çº¿ç¨‹ä¸æ˜¯ç¬¬ä¸€ä¸ªåˆ°è¾¾å±éšœçš„è¯ï¼Œå®ƒå°†ä¼šè¿›å…¥ç­‰å¾…ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹éƒ½åˆ°è¾¾ï¼Œé™¤éžå‘ç”Ÿ**è¢«ä¸­æ–­**ã€**å±éšœè¢«æ‹†é™¤**ã€**å±éšœè¢«é‡è®¾**ç­‰æƒ…å†µï¼›
* `public int await(long timeout, TimeUnit unit)`ï¼šå’Œawait()ç±»ä¼¼ï¼Œä½†æ˜¯åŠ ä¸Šäº†æ—¶é—´é™åˆ¶ï¼›
* `public boolean isBroken()`ï¼šå½“å‰å±éšœæ˜¯å¦è¢«æ‹†é™¤ï¼›
* `public void reset()`ï¼šé‡è®¾å½“å‰å±éšœã€‚ä¼šå…ˆæ‹†é™¤å±éšœå†è®¾ç½®æ–°çš„å±éšœï¼›
* `public int getNumberWaiting()`ï¼šæ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹æ•°é‡ã€‚

åœ¨CyclicBarrierçš„å„æ–¹æ³•ä¸­ï¼Œæœ€ä¸ºæ ¸å¿ƒçš„å°±æ˜¯`dowait()`ï¼Œä¸¤ä¸ª`await()`çš„å†…éƒ¨éƒ½æ˜¯è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚æ‰€ä»¥ï¼Œç†è§£äº†`dowait()`ï¼ŒåŸºæœ¬ä¸Šå°±ç†è§£äº†CyclicBarrierçš„å®žçŽ°å…³é”®ã€‚

`dowait()`æ–¹æ³•ç•¥é•¿ï¼Œç¨å¾®éœ€è¦ç‚¹è€å¿ƒï¼Œæˆ‘å·²ç»å¯¹å…¶ä¸­éƒ¨åˆ†åšäº†æ³¨é‡Šã€‚å½“ç„¶ï¼Œå¦‚æžœä½ æƒ³çœ‹æºç çš„è¯ï¼Œè¿˜æ˜¯å»ºè®®ç›´æŽ¥ä»ŽJDKä¸­çœ‹å®ƒçš„å…¨éƒ¨ï¼Œè¿™é‡Œçš„æºç åªæ˜¯ä¸ºäº†è¾…åŠ©ä½ ç†è§£ä¸Šä¸‹æ–‡ã€‚

```java
private int dowait(boolean timed, long nanos)
throws InterruptedException, BrokenBarrierException,TimeoutException {
    final ReentrantLock lock = this.lock;
    lock.lock(); // æ³¨æ„ï¼Œè¿™é‡Œæ˜¯ä¸€å®šè¦åŠ é”çš„
    try {
        final Generation g = generation;

        if (g.broken) // å¦‚æžœå½“å‰å±éšœè¢«æ‹†é™¤ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
            throw new BrokenBarrierException();

        if (Thread.interrupted()) { 
            breakBarrier(); // å¦‚æžœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™æ‹†é™¤å±éšœå¹¶æŠ›å‡ºå¼‚å¸¸
            throw new InterruptedException();
        }

        int index = --count; // å½“çº¿ç¨‹è°ƒç”¨awaitåŽï¼Œcountå‡1
        if (index == 0) { // tripped // å¦‚æžœcountä¸º0ï¼ŒæŽ¥ä¸‹æ¥å°†å°è¯•ç»“æŸå±éšœï¼Œå¹¶å¼€å¯æ–°çš„å±éšœ
            boolean ranAction = false;
            try {
                final Runnable command = barrierCommand;
                if (command != null)
                    command.run();
                ranAction = true;
                nextGeneration();
                return 0;
            } finally {
                if (!ranAction)
                    breakBarrier();
            }
        }

        // loop until tripped, broken, interrupted, or timed out
        for (;;) {
            try {
                if (!timed)
                    trip.await();
                else if (nanos > 0 L)
                    nanos = trip.awaitNanos(nanos);
            } catch (InterruptedException ie) {
                if (g == generation && !g.broken) {
                    breakBarrier();
                    throw ie;
                } else {
                    // We're about to finish waiting even if we had not
                    // been interrupted, so this interrupt is deemed to
                    // "belong" to subsequent execution.
                    Thread.currentThread().interrupt();
                }
            }

            if (g.broken)
                throw new BrokenBarrierException();

            if (g != generation)
                return index;

            if (timed && nanos <= 0 L) {
                breakBarrier();
                throw new TimeoutException();
            }
        }
    } finally {
        lock.unlock();
    }
}

```

å¯¹äºŽCyclicBarrierçš„æ ¸å¿ƒæ•°æ®ç»“æž„ã€æž„é€ å’Œæ–¹æ³•ï¼Œéƒ½åœ¨ä¸Šé¢ï¼Œå®ƒä»¬å¾ˆé‡è¦ã€‚ä½†æ˜¯ï¼Œæ›´ä¸ºé‡è¦çš„æ˜¯ï¼Œè¦ç†è§£CyclicBarrierçš„æ€æƒ³ï¼Œ**ä¹Ÿå°±æ˜¯ä¸‹é¢è¿™å¹…å€¼å¾—ä½ æ”¶è—çš„å›¾**ã€‚**ç†è§£äº†è¿™å¹…å›¾ï¼Œä¹Ÿå°±ç†è§£äº†CyclicBarrier**. 

![](https://writting.oss-cn-beijing.aliyuncs.com/2021/07/04/16254074996807.jpg)


æ­¤æ—¶ï¼Œä»Žè¿™å¹…å›¾å†å›žå¤´çœ‹ç¬¬ä¸€èŠ‚çš„ä¸¤ä¸ªåœºæ™¯ï¼Œé“ å’Œå¤§ä¹”å…ˆåŽåœ¨**å³¡è°·æ£®æž—**ã€**å°æ²³è¾¹**ä¸¤ä¸ªåœ°ç‚¹å¹½ä¼šã€‚é‚£ä¹ˆï¼Œå¦‚æžœä¹Ÿç”¨ä¸€å¹…å›¾æ¥è¡¨ç¤ºçš„è¯ï¼Œå®ƒåº”è¯¥æ˜¯ä¸‹é¢è¿™æ ·ï¼š

![](https://writting.oss-cn-beijing.aliyuncs.com/2021/07/04/16254035274264.jpg)

## ä¸‰ã€CyclicBarrierä¸ŽCountDownLatchæœ‰ä½•ä¸åŒ

å‰é¢ä¸¤èŠ‚å·²ç»æåˆ°äº†ä¸¤è€…çš„æ ¸å¿ƒä¸åŒï¼š

* **CountDownLatchæ˜¯ä¸€æ¬¡æ€§çš„ï¼Œè€ŒCyclicBarrieråˆ™å¯ä»¥å¤šæ¬¡è®¾ç½®å±éšœï¼Œå®žçŽ°é‡å¤åˆ©ç”¨**ï¼›
* **CountDownLatchä¸­çš„å„ä¸ªå­çº¿ç¨‹ä¸å¯ä»¥ç­‰å¾…å…¶ä»–çº¿ç¨‹ï¼Œåªèƒ½å®Œæˆè‡ªå·±çš„ä»»åŠ¡ï¼›è€ŒCyclicBarrierä¸­çš„å„ä¸ªçº¿ç¨‹å¯ä»¥ç­‰å¾…å…¶ä»–çº¿ç¨‹**ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒä»¬ä¿©è¿˜æœ‰ç€ä¸€äº›å…¶ä»–çš„ä¸åŒï¼Œæ•´ä½“æ±‡æ€»åŽå¦‚ä¸‹é¢çš„è¡¨æ ¼æ‰€ç¤ºï¼š

|CyclicBarrier|CountDownLatch|
|---|---|
|CyclicBarrieræ˜¯å¯é‡ç”¨çš„ï¼Œå…¶ä¸­çš„çº¿ç¨‹ä¼šç­‰å¾…æ‰€æœ‰çš„çº¿ç¨‹å®Œæˆä»»åŠ¡ã€‚å±Šæ—¶ï¼Œå±éšœå°†è¢«æ‹†é™¤ï¼Œå¹¶å¯ä»¥é€‰æ‹©æ€§åœ°åšä¸€äº›ç‰¹å®šçš„åŠ¨ä½œã€‚|CountDownLatchæ˜¯ä¸€æ¬¡æ€§çš„ï¼Œä¸åŒçš„çº¿ç¨‹åœ¨åŒä¸€ä¸ªè®¡æ•°å™¨ä¸Šå·¥ä½œï¼Œç›´åˆ°è®¡æ•°å™¨ä¸º0.|
|CyclicBarrieré¢å‘çš„æ˜¯çº¿ç¨‹æ•°|CountDownLatché¢å‘çš„æ˜¯ä»»åŠ¡æ•°|
|åœ¨ä½¿ç”¨CyclicBarrieræ—¶ï¼Œä½ å¿…é¡»åœ¨æž„é€ ä¸­æŒ‡å®šå‚ä¸Žåä½œçš„çº¿ç¨‹æ•°ï¼Œè¿™äº›çº¿ç¨‹å¿…é¡»è°ƒç”¨await()æ–¹æ³•|ä½¿ç”¨CountDownLatchæ—¶ï¼Œåˆ™å¿…é¡»è¦æŒ‡å®šä»»åŠ¡æ•°ï¼Œè‡³äºŽè¿™äº›ä»»åŠ¡ç”±å“ªäº›çº¿ç¨‹å®Œæˆæ— å…³ç´§è¦|
|CyclicBarrierå¯ä»¥åœ¨æ‰€æœ‰çš„çº¿ç¨‹é‡Šæ”¾åŽé‡æ–°ä½¿ç”¨|CountDownLatchåœ¨è®¡æ•°å™¨ä¸º0æ—¶ä¸èƒ½å†ä½¿ç”¨|
|åœ¨CyclicBarrierä¸­ï¼Œå¦‚æžœæŸä¸ªçº¿ç¨‹é‡åˆ°äº†ä¸­æ–­ã€è¶…æ—¶ç­‰é—®é¢˜æ—¶ï¼Œåˆ™å¤„äºŽawaitçš„çº¿ç¨‹éƒ½ä¼šå‡ºçŽ°é—®é¢˜|åœ¨CountDownLatchä¸­ï¼Œå¦‚æžœæŸä¸ªçº¿ç¨‹å‡ºçŽ°é—®é¢˜ï¼Œå…¶ä»–çº¿ç¨‹ä¸å—å½±å“|

## å°ç»“

ä»¥ä¸Šå°±æ˜¯å…³äºŽCyclicBarrierçš„å…¨éƒ¨å†…å®¹ã€‚åœ¨å­¦ä¹ CyclicBarrieræ—¶ï¼Œè¦ä¾§é‡ç†è§£å®ƒæ‰€è¦è§£å†³çš„é—®é¢˜åœºæ™¯ï¼Œä»¥åŠå®ƒä¸ŽCountDownLatchçš„ä¸åŒï¼Œç„¶åŽå†åŽ»çœ‹æºç ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬æ²¡æœ‰ä¸Šæ¥å°±æ”¾æºç è€Œæ˜¯ç»•å¼¯è®²äº†ä¸ªæ•…äº‹çš„åŽŸå› ï¼Œè™½ç„¶é‚£ä¸ªæ•…äº‹æŒºâ€œç‹—è¡€â€ã€‚å½“ç„¶ï¼Œå¦‚æžœè¿™ä¸ªç‹—è¡€çš„æ•…äº‹èƒ½è®©ä½ è®°ä½è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼Œç‹—è¡€ä¹Ÿå€¼å¾—äº†ã€‚

æ­£æ–‡åˆ°æ­¤ç»“æŸï¼Œæ­å–œä½ åˆä¸Šäº†ä¸€é¢—æ˜Ÿâœ¨

## å¤«å­çš„è¯•ç‚¼

* ç¼–å†™ä»£ç ä½“éªŒCyclicBarrierç”¨æ³•ã€‚

## å»¶ä¼¸é˜…è¯»ä¸Žå‚è€ƒèµ„æ–™

* æŽ˜é‡‘ä¸“æ ï¼šhttps://juejin.cn/column/6963590682602635294
* githubï¼šhttps://github.com/ThoughtsBeta/TheKingOfConcurrency

## å…³äºŽä½œè€…

ä¸“æ³¨é«˜å¹¶å‘é¢†åŸŸåˆ›ä½œã€‚äººæ°”ä¸“æ ã€ŠçŽ‹è€…å¹¶å‘è¯¾ã€‹ã€å°å†Œã€Š[é«˜å¹¶å‘ç§’æ€çš„è®¾è®¡ç²¾è¦ä¸Žå®žçŽ°](https://juejin.cn/book/7008372989179723787)ã€‹ä½œè€…ï¼Œå…³æ³¨å…¬ä¼—å·ã€MetaThoughtsã€‘ï¼ŒåŠæ—¶èŽ·å–æ–‡ç« æ›´æ–°å’Œæ–‡ç¨¿ã€‚

---

å¦‚æžœæœ¬æ–‡å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿Ž**ç‚¹èµž**ã€**å…³æ³¨**ã€**ç›‘ç£**ï¼Œæˆ‘ä»¬ä¸€èµ·**ä»Žé’é“œåˆ°çŽ‹è€…**ã€‚

